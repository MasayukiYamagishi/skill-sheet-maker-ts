name: CI/CD Pipeline

# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãŠã‚ˆã³æ‰‹å‹•å®Ÿè¡Œæ™‚ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  NODE_ENV: production
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  # åŸºæœ¬çš„ãªãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ10åˆ†ï¼‰
    timeout-minutes: 10

    steps:
    # ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ï¼‰
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "Installing dependencies..."
        npm ci --prefer-offline --no-audit --no-fund

    # Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç”Ÿæˆã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: ğŸ”„ Generate Prisma Client
      run: |
        echo "Generating Prisma client..."
        npm run db:generate

    # ESLintãƒã‚§ãƒƒã‚¯ï¼ˆã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒã‚§ãƒƒã‚¯ï¼‰
    - name: ğŸ” Run ESLint
      run: |
        echo "Running ESLint..."
        npm run lint

    # TypeScriptãƒã‚§ãƒƒã‚¯ï¼ˆã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã€Next.jsç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼‰
    - name: ğŸ” Run TypeScript check (source files only)
      run: |
        echo "Running TypeScript check on source files..."
        # src/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
        npx tsc --noEmit --skipLibCheck --project tsconfig.json \
          --include "src/**/*" \
          --exclude ".next/**/*"

    # Next.jsãƒ“ãƒ«ãƒ‰ï¼ˆãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å‘ã‘ï¼‰
    - name: ğŸ—ï¸ Build application
      run: |
        echo "Building Next.js application..."
        # CIç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰ï¼ˆTypeScriptã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        CI=true npm run build

    # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®åˆ†æ
    - name: ğŸ“Š Analyze build output
      run: |
        echo "ğŸ“Š Build Analysis:"
        echo "================================"
        
        # ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã®ç¢ºèª
        if [ -d ".next" ]; then
          echo "ğŸ“ Build directory size:"
          du -sh .next/
          echo ""
          
          # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
          if [ -d ".next/static" ]; then
            echo "ğŸ“ Static files:"
            find .next/static -name "*.js" -o -name "*.css" | head -10 | xargs ls -lh
            echo ""
          fi
          
          # ãƒãƒ£ãƒ³ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºç¢ºèª
          if [ -d ".next/static/chunks" ]; then
            echo "ğŸ“ Top 5 largest chunks:"
            find .next/static/chunks -name "*.js" -exec du -h {} + | sort -rh | head -5
          fi
        else
          echo "âŒ Build directory not found!"
          exit 1
        fi

    # ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæ¬¡å›å®Ÿè¡Œæ™‚ã®é«˜é€ŸåŒ–ï¼‰
    - name: ğŸ’¾ Cache build artifacts
      uses: actions/cache@v4
      with:
        path: |
          .next/cache
          node_modules/.cache
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

    # æˆåŠŸé€šçŸ¥
    - name: âœ… Success notification
      if: success()
      run: |
        echo "ğŸ‰ CI/CD Pipeline completed successfully!"
        echo ""
        echo "ğŸ“‹ Completed tasks:"
        echo "  â€¢ Dependencies installed"
        echo "  â€¢ Prisma client generated"
        echo "  â€¢ ESLint checks passed"
        echo "  â€¢ TypeScript checks passed"
        echo "  â€¢ Production build successful"
        echo "  â€¢ Build analysis completed"
        echo ""
        echo "Ready for deployment! ğŸš€"

    # å¤±æ•—æ™‚ã®è©³ç´°ãƒ­ã‚°
    - name: âŒ Failure notification
      if: failure()
      run: |
        echo "âŒ CI/CD Pipeline failed!"
        echo ""
        echo "ğŸ” Debugging information:"
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        
        if [ -f "lint-results.txt" ]; then
          echo ""
          echo "ğŸ“‹ Lint Results:"
          cat lint-results.txt
        fi
        
        if [ -f "typecheck-results.txt" ]; then
          echo ""
          echo "ğŸ“‹ TypeCheck Results:"
          cat typecheck-results.txt
        fi
        
        echo ""
        echo "ğŸ’¡ Common fixes:"
        echo "  â€¢ Run 'npm run lint:fix' for linting issues"
        echo "  â€¢ Run 'npm run type-check' locally to debug TypeScript errors"
        echo "  â€¢ Check if all dependencies are properly installed"
        echo "  â€¢ Ensure Prisma schema is valid"
        exit 1