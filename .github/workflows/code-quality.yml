name: Code Quality Check

# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ã‚ˆã‚Šè©³ç´°ãªã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
on:
  pull_request:
    branches: [ main ]

jobs:
  code-quality-check:
    name: Comprehensive Code Quality Check
    runs-on: ubuntu-latest

    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout code
      uses: actions/checkout@v4

    # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: Install dependencies
      run: npm ci

    # Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç”Ÿæˆ
    - name: Generate Prisma Client
      run: npm run db:generate

    # ESLintã«ã‚ˆã‚‹è©³ç´°ãªã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    - name: Run ESLint with detailed output
      run: |
        echo "ğŸ” Running ESLint..."
        npm run lint -- --format=compact

    # TypeScriptã®å³å¯†ãªå‹ãƒã‚§ãƒƒã‚¯
    - name: Run TypeScript strict type check
      run: |
        echo "ğŸ” Running TypeScript type check..."
        npm run type-check

    # Prettierã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    - name: Check code formatting with Prettier
      run: |
        echo "ğŸ” Checking code formatting..."
        npm run format -- --check || {
          echo "âŒ Code formatting issues found!"
          echo "Run 'npm run format' to fix formatting issues."
          exit 1
        }

    # Next.jsãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆæœ¬ç•ªç’°å¢ƒæƒ³å®šï¼‰
    - name: Build for production
      run: |
        echo "ğŸ—ï¸ Building for production..."
        npm run build

    # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚µã‚¤ã‚ºç¢ºèª
    - name: Check build output size
      run: |
        echo "ğŸ“Š Build output analysis:"
        ls -la .next/static/chunks/ || echo "Static chunks directory not found"
        du -sh .next/ || echo "Next.js build directory not found"

    # æˆåŠŸæ™‚ã®ç·åˆãƒ¬ãƒãƒ¼ãƒˆ
    - name: Quality check success report
      if: success()
      run: |
        echo "âœ… All code quality checks passed!"
        echo ""
        echo "ğŸ“‹ Completed checks:"
        echo "  â€¢ ESLint: Code quality âœ…"
        echo "  â€¢ TypeScript: Type safety âœ…"
        echo "  â€¢ Prettier: Code formatting âœ…"
        echo "  â€¢ Next.js: Production build âœ…"
        echo "  â€¢ Build size: Output analysis âœ…"
        echo ""
        echo "ğŸ‰ Ready for merge!"

    # å¤±æ•—æ™‚ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
    - name: Quality check failure report
      if: failure()
      run: |
        echo "âŒ Code quality checks failed!"
        echo ""
        echo "Please fix the issues above before merging."
        echo "Common fixes:"
        echo "  â€¢ Run 'npm run lint:fix' for ESLint issues"
        echo "  â€¢ Run 'npm run format' for Prettier formatting"
        echo "  â€¢ Check TypeScript errors with 'npm run type-check'"
        echo "  â€¢ Test build locally with 'npm run build'"
        exit 1